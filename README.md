# Цель
Разработать микросервис для извлечения данных авторизации в месенджер Telegram из виртуального Android.
# Задачи
1. Исследование необходимых параметров для конфигурации виртуального Android и их влияния на видимые параметры Telegram 
2. Исследование методов по управлению и взаимодействию с виртуальным Android 
3. Исследование и разработка способа извлечения данных сессии Telegram 
4. Разработать микросервис для автоматизированного извлечения данных сессии из виртуального Android 
5. Реализовать переавторизацию по полученным данным

# Документация исследования
## Сравнительная таблица виртуальных Android решений

| Решение                     | Производительность                                                    | API/автоматизация     | Интеграция с Docker                           |
| --------------------------- | --------------------------------------------------------------------- | --------------------- | --------------------------------------------- |
| **Redroid**                 | Высокая (поддержка Linux контейнеров), плохая совместимость с Windows | ADB, HW ускорение     | Готовый образ Docker                          |
| **Android Studio Emulator** | Средняя (требует GUI или QEMU)                                        | ADB, Emulator Console | Сложная, требует KVM, вложенная виртуализация |
| **LDPlayer**                | Хорошая совместимость с Windows                                       | ADB                   | Отсутсвует                                    |

## Спецификация конфигурации Android

- Версия: Android 11.0.0 (также тестировался 8.1.0)
- Ресурсы: 2GB RAM
- Хранилище: ~3GB на контейнер
- Права: Обязательно наличие Root (для доступа к /data/data)
- Параметры запуска: androidboot.redroid_gpu_mode=guest (без GPU)

## Методы управления Android


| Критерий                                           | ADB / Скрипты                                                                                                                                                            | Device Owner / Profile Owner напрямую                                                                                                                                                       | Android Management API                                                                                                                             |
| -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Простота интеграции: наличие готовых библиотек** | Готовые библиотеки минимальны; в основном `adb` CLI + самописные скрипты (bash, Python, PowerShell)                                                                      | Используются стандартные Android API. Нужна разработка собственного DPC или использование базовых инструментов развертывания.                                                               | Есть официальные клиентские библиотеки Google (Java, Node.js, Python) и хороший REST API. Интеграция через стандартные HTTP‑клиенты тоже проста.   |
| **Количество библиотек**                           | Много мелких оберток под ADB, но без единого стандарта и с разным качеством. Часто приходится собирать все вручную.                                                      | По сути одна платформа (Android SDK). Все стабильно, но нужен высокий порог входа: нужно писать и сопровождать свой DPC‑клиент.                                                             | Библиотек немного, но они поддерживаются Google, есть официальные клиенты и примеры. Дополнительно можно интегрировать через обычные REST‑клиенты. |
| **Количество параметров настройки**                | Настройки задаются через команды ADB и скрипты. Нет единой схемы параметров.                                                                                             | Очень много возможных политик Конфиг гибкий, но сложный.                                                                                                                                    | Параметры структурированы в моделях политик (JSON/REST). Проще, чем писать все на чистом Android SDK, но сложнее, чем минимальный ADB‑скрипт.      |
| **Объем документации, коммьюнити**                 | Документации по ADB и отдельным командам много, но она фрагментирована. Коммьюнити большое (StackOverflow, форумы). Централизованного гида почти нет.                    | Официальная документация Android Enterprise/Device Administration подробная, примеров много, но нужно время, чтобы разобраться в архитектуре. Коммьюнити есть, но тематика уже более узкая. | Хорошая официальная документация и примеры. Тематика относительно новая, но быстро развивается, есть статьи, видео, готовые демо‑проекты.          |
| **Скорость отклика**                               | Почти мгновенно при локальном подключении по USB или по ADB over TCP/IP в локальной сети. Для удаленных устройств нужно организовывать туннели/VPN, что усложняет схему. | Зависит от того, как реализован DPC. При локальных действиях отклик быстрый                                                                                                                 | Запрос от сервера к Google и далее пуш на устройство, достаточно быстро, но не рилтайм.                                                            |
| **Надежность**                                     | Зависит от качества  скриптов. ADB не предназначен как промышленный протокол управления, легко получить таймауты, разрывы соединения                                     | Надежность хорошая, так как используются поддерживаемые системные API.                                                                                                                      | Высокая: API поддерживается самим Google, протоколы и delivery‑механизмы отлажены. Ошибки обычно хорошо описаны в ответах API.                     |

Выбранный метод: прямое управление через ADB - нет UI,  только работа с файловой системой и процессами через cat и pull.

## Спецификация извлечения данных
| Параметр     | Описание                             | Локация файла                                                  | Метод извлечения                                    | Требования |
| ------------ | ------------------------------------ | -------------------------------------------------------------- | --------------------------------------------------- | ---------- |
| **user_id**  | Уникальный ID пользователя           | /data/data/org.telegram.messenger/shared_prefs/userconfing.xml | Regex парсинг тега <int name="user_id">             | Root       |
| **dc_id**    | ID Дата-центра (сервера)             | /data/data/org.telegram.messenger/shared_prefs/userconfing.xml | Regex парсинг тега <int name="currentDatacenterId"> | Root       |
| **auth_key** | Бинарный ключ авторизации (256 байт) | /data/data/org.telegram.messenger/files/tgnet.dat              | Чтение бинарного потока -> Base64 кодирование       | Root       |

## Алгоритм жизненного цикла
1. **Инициализация:**
    - Запуск Docker Compose.
    - Старт контейнера android (Redroid). Загрузка OS, запуск демона.
    - Старт контейнера extractor. Инициализация HTTP-сервера на порту 8080.
2. **Подготовка среды:**
    - Оператор подключается к Android.
    - Установка приложения Telegram.
    - Ручная авторизация пользователя.
    - Результат: telegram генерирует файлы сессии в защищенной области /data/data.
3. **Извлечение данных:**
    - Клиент отправляет запрос GET /extract.
    - Микросервис устанавливает adb-соединение.
    - Получение прав Root.
    - Чтение XML-конфигурации (cat userconfing.xml) -> парсинг RegEx -> получение User ID, DC ID.
    - Чтение бинарного ключа (cat tgnet.dat) -> Кодирование в Base64.
    - Возврат JSON-ответа клиенту.
4. **Проверка:**
    - Клиент отправляет запрос GET /check.
    - Микросервис инициализирует MTProto-клиент (gotd) с использованием AppID микросервиса и извлеченного AuthKey.
    - Попытка вызова метода users.getFullUser.
    - Обработка ответа от Telegram API (Успех или ошибка шифрования).

## Архитектурная диаграмма

![[Pasted image 20260205233043.png]]

## Программный комплекс
### Структура проекта
#### main.go
Использует os/exec для вызова системных команд. 
Функция extractHandler`:
    - adb connect: соединяет сервис с телефоном по TCP/IP.
    - adb root: переключает adb в режим суперпользователя.
    - cat ...xml: читает текстовый конфиг. С помощью регулярных выражений находит строки.
    - cat ...tgnet.dat: читает бинарный файл. Так как бинарник нельзя просто так вставить в JSON, он прогоняется через base64.
Функция checkHandler:
    - Берет данные, которые нашел экстрактор.
    - Создает telegram.NewClient (gotd).

#### Dockerfile
Устанавливается пакет android-tools для adb.

#### Docker Compose
Определяет два сервиса:

1. android: Образ redroid/redroid. Запускается в привилегированном режиме (privileged: true) для доступа к оборудованию.
2. extractor: go-сервис. Зависит от старта андроида (depends_on). 

## Инструкция по запуску
```
docker compose up --build
adb connect localhost:5555
установить телеграм на устройство (если нет)
запуск telegram - adb shell monkey -p org.telegram.messenger -c android.intent.category.LAUNCHER 1
после входа в аккаунт перейти на http://localhost:8080/extract
для остановки - docker compose down
```

## Пример запуска
Поднятый контейнер и подключение к redroid + установка на него тг
![[Pasted image 20260206000707.png]]

ответ с id и ключом в base64
![[Pasted image 20260206000801.png]]

## Анализ реализации
В ходе тестирования на официальном клиенте telegram были получены следующие результаты:

- Доступ к файловой системе: успешный. Сервис получает доступ к директории /data/data/org.telegram.messenger.
- Извлечение tgnet.dat: успешное. Бинарный файл сессии извлекается и передается клиенту.
- Парсинг XML: частично успешный.
    - В современных версиях telegram используется обфускация имен ключей в XML-конфигах (отсутствие явного ключа user_id), либо миграция части настроек в protobuf-хранилище.
    - Алгоритм предусматривает возвращение дефолтных значений (0), если явный паттерн не найден, сохраняя при этом сам факт доступа к файлу.


При попытке использовать извлеченный auth_key в стороннем клиенте (библиотека `gotd`) сервер возвращает ошибку 401 AUTH_KEY_UNREGISTERED или AUTH_KEY_INVALID.
![[Pasted image 20260206001524.png]]

Официальный клиент telegram для Android использует механизм Android Keystore System. Ключ авторизации, хранящийся в tgnet.dat, дополнительно зашифрован аппаратным ключом устройства.  
Прямое извлечение файла не позволяет расшифровать его содержимое.

Программа успешно реализует механику доставки данных из защищенной области Android. Для получения чистого ключа необходимо использовать модифицированные клиенты telegram или производить дамп памяти процесса.